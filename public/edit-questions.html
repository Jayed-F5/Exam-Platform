<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Modifier l'Examen</title>
  <link rel="stylesheet" href="styleEditQuestions.css" />
</head>
<body class="edit-questions-page">
  <div class="container">
    <h1>Modifier l'Examen</h1>

    <form id="examInfoForm" style="margin-bottom: 40px;">
      <label>Titre :</label><br>
      <input type="text" id="examTitle" name="title"><br>

      <label>Description :</label><br>
      <textarea id="examDescription" name="description"></textarea><br>

      <label>Public cibl√© :</label><br>
      <input type="text" id="examTarget" name="target_group"><br>

      <button type="submit">üíæ Mettre √† jour l'examen</button>
    </form>

    <h2>Questions existantes</h2>
    <div id="questionsContainer"></div>

    <button onclick="window.location.href='/add-questions.html?examId=' + examId" class="btn">
      ‚ûï Ajouter une nouvelle question
    </button>
  </div>

  <script>
    const examId = new URLSearchParams(window.location.search).get('examId');
    const questionsContainer = document.getElementById('questionsContainer');

    async function loadExam() {
      const res = await fetch('/api/exams/get', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ examId })
      });

      const data = await res.json();
      questionsContainer.innerHTML = '';

      if (!data.success || !data.exam) {
        questionsContainer.innerHTML = '<div class="error-message">Erreur de chargement de l\'examen.</div>';
        return;
      }

      document.getElementById('examTitle').value = data.exam.title || '';
      document.getElementById('examDescription').value = data.exam.description || '';
      document.getElementById('examTarget').value = data.exam.target_group || '';

      data.exam.questions.forEach(q => {
        const div = document.createElement('div');
        div.className = 'question-block';

        div.innerHTML = `
          <form data-id="${q.id}">
            <h3>Question #${q.id} (${q.type})</h3>
            <label>√ânonc√© :</label><br>
            <textarea name="statement">${q.statement}</textarea><br>

            ${q.type === 'direct' ? `
              <label>R√©ponse :</label><br>
              <input type="text" name="answer" value="${q.answer || ''}"><br>
              <label>Tol√©rance :</label><br>
              <input type="number" name="tolerance" value="${q.tolerance || 0}"><br>
            ` : ''}

            ${q.type === 'qcm' ? q.options.map(opt => `
              <div class="option-block">
                <input type="text" name="option${opt.id}" value="${opt.option_text}">
                <label><input type="checkbox" name="correct[]" value="${opt.id}" ${opt.is_correct ? 'checked' : ''}> Correct</label>
              </div>
            `).join('') : ''}

            <label>Dur√©e :</label><br>
            <input type="number" name="duration" value="${q.duration}"><br>
            <label>Points :</label><br>
            <input type="number" name="points" value="${q.points}"><br>

            <button type="submit">üíæ Enregistrer</button>
            <button type="button" onclick="confirmDelete(${q.id}, this)">üóëÔ∏è Supprimer</button>
            <div class="feedback-message" style="display:none;"></div>
          </form>
        `;
        questionsContainer.appendChild(div);
      });

      addFormListeners();
    }

    function addFormListeners() {
      const forms = questionsContainer.querySelectorAll('form');
      forms.forEach(form => {
        form.addEventListener('submit', async e => {
          e.preventDefault();
          const questionId = form.dataset.id;
          const formData = new FormData(form);

          const body = {
            statement: formData.get('statement'),
            duration: formData.get('duration'),
            points: formData.get('points'),
            answer: formData.get('answer') || null,
            tolerance: formData.get('tolerance') || null,
            correct: formData.getAll('correct[]'),
            options: {}
          };

          form.querySelectorAll('input[type="text"][name^="option"]').forEach(input => {
            const id = input.name.replace('option', '');
            body.options[id] = input.value;
          });

          const res = await fetch(`/api/questions/${questionId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });

          const result = await res.json();
          showMessage(form, result.success ? '‚úÖ Question mise √† jour.' : '‚ùå Erreur lors de la mise √† jour.', result.success);
        });
      });
    }

    function confirmDelete(id, btn) {
      const form = btn.closest('form');
      const existing = form.querySelector('.confirm-delete');
      if (existing) return;

      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'confirm-delete';
      confirmDiv.innerHTML = `
        <span>Confirmer la suppression ?</span>
        <button type="button" class="btn" onclick="deleteQuestion(${id}, this)">‚úÖ Oui</button>
        <button type="button" class="btn" onclick="this.parentElement.remove()">‚ùå Non</button>
      `;
      form.appendChild(confirmDiv);
    }

    async function deleteQuestion(id, btn) {
      const form = btn.closest('form');
      const res = await fetch(`/api/questions/${id}`, { method: 'DELETE' });
      const data = await res.json();

      if (data.success) {
        showMessage(form, 'üóëÔ∏è Question supprim√©e avec succ√®s.', true);
        setTimeout(() => form.remove(), 500); // remove form after brief delay
      } else {
        showMessage(form, '‚ùå Erreur lors de la suppression.', false);
      }
    }

    function showMessage(form, msg, success = true) {
      const box = form.querySelector('.feedback-message');
      box.textContent = msg;
      box.style.color = success ? 'green' : 'red';
      box.style.display = 'block';
      setTimeout(() => {
        box.textContent = '';
        box.style.display = 'none';
      }, 5000);
    }

    document.getElementById('examInfoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('examTitle').value;
      const description = document.getElementById('examDescription').value;
      const target_group = document.getElementById('examTarget').value;

      const res = await fetch(`/api/exams/${examId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, description, target_group })
      });

      const result = await res.json();
      const message = result.success
        ? '‚úÖ Informations de l\'examen mises √† jour.'
        : '‚ùå Erreur lors de la mise √† jour de l\'examen.';
      alert(message);
    });

    loadExam();
  </script>
</body>
</html>
